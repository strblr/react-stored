"use strict";var _react=require("react");Object.defineProperty(exports,"__esModule",{value:!0}),exports.readStore=exports.useStore=exports.addSchema=exports.config=void 0;function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(a){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}}var storeStorage=window.localStorage,storeKeyPrefix="",storeCrossTab=!1,storeSerialize=JSON.stringify,storeDeserialize=JSON.parse,storeSchemas=[],config=function(a){var b=a.storage,c=a.keyPrefix,d=a.crossTab,e=a.serialize,f=a.deserialize,g=a.schemas;b&&(storeStorage=b),"string"==typeof c&&(storeKeyPrefix=c),"boolean"==typeof d&&(storeCrossTab=d),e&&(storeSerialize=e),f&&(storeDeserialize=f),g&&storeSchemas.push.apply(storeSchemas,_toConsumableArray(g))};exports.config=config;var addSchema=function(a,b,c){storeSchemas.push({key:a,init:b,assert:c})};exports.addSchema=addSchema;var storeUpdaters={},addUpdater=function(a,b){a in storeUpdaters?storeUpdaters[a].push(b):storeUpdaters[a]=[b]},removeUpdater=function(a,b){if(a in storeUpdaters){var c=storeUpdaters[a].indexOf(b);-1!==c&&storeUpdaters[a].splice(c,1)}},callUpdaters=function(a,b){if(a in storeUpdaters){var c=!0,d=!1,e=void 0;try{for(var f,g,h=storeUpdaters[a][Symbol.iterator]();!(c=(f=h.next()).done);c=!0)g=f.value,g(b)}catch(a){d=!0,e=a}finally{try{c||null==h.return||h.return()}finally{if(d)throw e}}}};window.addEventListener("storage",function(a){storeCrossTab&&a.storageArea===storeStorage&&a.key&&a.key.startsWith(storeKeyPrefix)&&null!==a.oldValue&&null!==a.newValue&&callUpdaters(a.key.substring(storeKeyPrefix.length),storeDeserialize(a.newValue))});var useStore=function(a,b,c){var d=(0,_react.useRef)(),e=(0,_react.useMemo)(function(){return storeSchemas.find(function(b){return"string"==typeof b.key?b.key===a:b.key.test(a)})},[a]);(0,_react.useMemo)(function(){var f=[b,e&&e.init,null].find(function(a){return a!==void 0}),g=c||e&&e.assert;try{var h=storeStorage.getItem("".concat(storeKeyPrefix).concat(a));if(null===h)throw new Error;var i=storeDeserialize(h);if(g&&!g(i))throw new Error;d.current=i}catch(b){storeStorage.setItem("".concat(storeKeyPrefix).concat(a),storeSerialize(f)),d.current=f}},[a,b,c,e]);var f=(0,_react.useState)({})[1];(0,_react.useEffect)(function(){var b=function(a){d.current=a,f({})};return addUpdater(a,b),function(){removeUpdater(a,b)}},[a,f]);var g=(0,_react.useCallback)(function(b){"function"==typeof b&&(b=b(d.current)),storeStorage.setItem("".concat(storeKeyPrefix).concat(a),storeSerialize(b)),callUpdaters(a,b)},[a]);return[d.current,g]};exports.useStore=useStore;var readStore=function(a){var b=storeStorage.getItem("".concat(storeKeyPrefix).concat(a));return storeDeserialize(b)};exports.readStore=readStore;
